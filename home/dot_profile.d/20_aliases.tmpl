#!/usr/bin/env bash
# shellcheck disable=SC2139

###
# Versions for ensure wrappers
BTOP_VERSION="1.2.13"
CHEZMOI_VERSION="2.45.0"
DIFFTASTIC_VERSION="0.54.0"
DIRENV_VERSION="2.33.0"
ENSURE_VERSION="0.3.1"
EZA_VERSION="0.17.0"
FD_VERSION="9.0.0"
FZF_VERSION="0.46.0"
GH_VERSION="2.40.1"
GIT_FLOW_VERSION="0.4.0"
GOLANGCI_LINT_VERSION="1.55.2"
GOPLS_VERSION="0.14.2"
GO_VERSION="1.21.6"
HELIX_VERSION="23.10"
JUST_VERSION="1.23.0"
MOCKGEN_VERSION="0.4.0"
RIPGREP_VERSION="14.1.0"
RUSTUP_VERSION="1.26.0"
STATICCHECK_VERSION="0.4.6"
YQ_VERSION="4.40.5"
ZELLIJ_VERSION="0.39.2"

__ensure_path() {
  which -as ensure | \grep -E '^/' | cut -d' ' -f1
}

__install_ensure() {
  \go install "go.mway.dev/ensure@v${ENSURE_VERSION}"
}

ensure() {
  __ensure_path &>/dev/null || __install_ensure

  local prog;
  prog="$(__ensure_path)"
  if [ -z "$prog" ]; then
    echo "Ensure not found, installing..."
    __install_ensure
  fi

  "$prog" --version 2>&1 | \grep "v${ENSURE_VERSION}" >/dev/null || {
    echo "Updating ensure..."
    __install_ensure
  }

  local debug;
  [ -z "$ENSURE_DEBUG" ] || debug="--debug"
  "$prog" $debug "$@"
}

{{ if eq .chezmoi.os "linux" -}}
overrides="--config='$HOME/.config/ensure/overrides.yml'"
{{ else -}}
overrides=""
{{ end -}}

###
# Wrapper aliases around ensure
alias ansi="ensure file ansi --"
alias btop="ensure archive btop --version='${BTOP_VERSION}' --"
alias chezmoi="ensure script chezmoi --version='${CHEZMOI_VERSION}' --"
alias difft="ensure cargo difft --version='${DIFFTASTIC_VERSION}' --"
alias direnv="ensure script direnv --version='${DIRENV_VERSION}' --"
alias ensure-ensure="ensure go ensure --version='${ENSURE_VERSION}' --"
alias eza="ensure cargo eza --version='${EZA_VERSION}' --"
alias fd="ensure cargo fd --version='${FD_VERSION}' -- --no-ignore --hidden"
alias fzf="ensure archive fzf $overrides --version='${FZF_VERSION}' --"
alias gh="ensure archive gh --version='${GH_VERSION}' --"
alias go="GOTOOLCHAIN=go${GO_VERSION} ensure archive go --version='${GO_VERSION}' --"
alias golangci-lint="ensure archive golangci-lint --version='${GOLANGCI_LINT_VERSION}' --"
alias gopls="ensure go gopls --version='${GOPLS_VERSION}' --"
alias hx="ensure cargo hx --version='${HELIX_VERSION}' --"
alias just="ensure cargo just --version='${JUST_VERSION}' -- --unstable"
alias mockgen="ensure go mockgen --version='${MOCKGEN_VERSION}' --"
alias rg="ensure cargo rg --version='${RIPGREP_VERSION}' --"
alias rustup="ensure script rustup --version='${RUSTUP_VERSION}' --"
alias staticcheck="ensure go staticcheck --version='${STATICCHECK_VERSION}' --"
alias yq="ensure go yq --version='${YQ_VERSION}' --"
alias zellij="ensure cargo zellij --version='${ZELLIJ_VERSION}' --"
alias git-flow="ensure go git-flow --package='go.mway.dev/git/cmd/git-flow' --version='${GIT_FLOW_VERSION}' --"

###
# Other aliases
alias cm='chezmoi'
alias grep='rg'
alias htop='sudo htop'
alias ls='eza -al'
alias lsg='ls --git'
alias mkdir='mkdir -p'
alias oplogin='eval $(op signin)'
alias update="source $0"  # TODO: consider having this alias source everything
