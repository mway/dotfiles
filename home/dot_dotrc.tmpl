#!/usr/bin/env bash

[ -z "$MWAY_FORCE_DOTRC" ] || { unset MWAY_DOTRC; unset MWAY_FORCE_DOTRC; }

if [[ $MWAY_DOTRC -ne 1 ]]; then
    export MWAY_DOTRC=1

    shopt -s autocd 2>/dev/null
    shopt -s cdspell 2>/dev/null
    shopt -s globstar 2>/dev/null
    shopt -s nocaseglob 2>/dev/null

    # Well-known paths
    export PATH="/usr/local/sbin:/usr/local/bin:$PATH"
    _profiled_files="$(find {{ quote (print .paths.user.home "/.profile.d") }} -type f | sort)"

    function PATH_add() {
        for dir in "$@"; do
            [ -z "$dir" ] || PATH="$dir${PATH:+:${PATH}}"
        done

        # https://stackoverflow.com/a/44232192
        PATH="$(perl -e 'print join(":", grep { not $seen{$_}++ } split(/:/, $ENV{PATH}))')"

        export PATH
    }

    for f in $_profiled_files; do
        # shellcheck source=/dev/null
        source "$f" || echo "[{{ print .paths.user.home "/.dotrc" }}] Failed to source $f"
    done

    # Give {{ .paths.local.bin }} and {{ .paths.user.bin }} precedence.
    PATH_add {{ quote .paths.local.bin }} {{ quote .paths.user.bin }}

    set +e
fi
